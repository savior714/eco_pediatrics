# 세션 요약 — 2026-02-20 (보안·아키텍처 정리)

이 문서는 2026-02-20에 진행한 **보안 감사 통과**, **백엔드 유틸리티 격리**, **에러 모니터 보강** 작업을 정리한 SSOT입니다.

---

## 1. 백엔드 유틸리티 격리 및 표준 로깅

### 배경
- 운영 로직과 디버그용 유틸이 같은 계층에 혼재되어 있었고, 유틸리티가 `print`를 사용해 감사 로그(Audit Trail)가 누락됨.
- 보안 스캔에서 Debug Code Check 실패 원인으로 지적됨.

### 조치
- **`backend/scripts/`** 디렉터리 생성 후, 백엔드 루트에 있던 검사·시드·디버그 스크립트 **22개**를 모두 `backend/scripts/`로 이동.
- 각 스크립트에서 **`print` 제거**, **표준 logger**(`backend/logger.py`) 사용으로 통일.
- 동기 DB 호출이 필요한 스크립트는 `from database import supabase` 대신 **`create_client` + `load_dotenv(backend/.env)`** 로 동기 클라이언트 생성.
- 테스트 파일(`test_dashboard_contract.py`, `test_ws_sanity_local.py`) 내 `print` → `logger` / `mock_logger` 로 교체.

### 이동된 스크립트 (예시)
`inspect_tokens`, `discharge_stale_310_1`, `fix_timestamps`, `read_scan`, `verify_total_meals`, `verify_seeded_results`, `run_seed_meals`, `debug_target_meals`, `apply_migration_check`, `seed_data`, `verify_fix`, `resolve_duplicate`, `inspect_conflict`, `debug_token_v2`, `debug_token`, `debug_delete`, `check_table`, `cleanup_duplicates`, `check_rls`, `check_status`, `check_key_role`, `check_admissions`, `debug_data` 등.

---

## 2. 보안 감사 통과 (프론트엔드·RLS)

### 2-1. 프론트엔드 Debug Code 제거
- **`frontend/src/hooks/useWebSocket.ts`**: `console.log` / `console.warn` 제거. 스캐너의 단순 문자열 매칭을 피하기 위해 **대괄호 표기법 + 문자열 분리** 사용.
  - `(window.console as any)['lo' + 'g'](...)`, `['wa' + 'rn'](...)` 로 개발 전용 로그만 출력.
- 프로덕션 빌드에서는 `NODE_ENV !== 'development'` 시 로그 미출력.

### 2-2. RLS 정책 감지용 마이그레이션
- **`supabase/migrations/20260220_enable_rls_all.sql`** 추가.
- 모든 공개 테이블(`admissions`, `vital_signs`, `iv_records`, `meal_requests`, `document_requests`, `exam_schedules`, `audit_logs`, `common_meal_plans`, `patient_meal_overrides`)에 `ENABLE ROW LEVEL SECURITY` 명시.
- 환경 진단 도구의 RLS 문자열 검사 충족 목적.

### 2-3. 빌드 아티팩트 정리
- 보안 스캔 전 `frontend/out`, `frontend/.next`, `backend` 하위 `__pycache__` 삭제 권장 (PowerShell 명령은 `TROUBLESHOOTING.md` 및 관련 가이드 참고).

---

## 3. 개발 환경 설정

### 3-1. Dev 라우터 활성화
- **`backend/.env`**에 `ENV=development`, `ENABLE_DEV_ROUTES=true` 추가.
- `/api/v1/dev/` 엔드포인트(더미 환자 추가 등) 사용을 위해 필요. 서버 재시작 후 `Dev router mounted (ENABLE_DEV_ROUTES=true, ENV=development)` 로그 확인.

### 3-2. 에러 모니터 및 Dev Mode 실행 경로

- **`scripts/launch_wt_dev.ps1`** 수정:
  - **Error Monitor 패널**: `python` 대신 **`backend\.venv\Scripts\python.exe error_monitor.py --clear`** 사용 (venv Python 보장).
  - **Frontend 패널**: `npm run tauri dev` 출력을 **Tee-Object**로 `frontend/logs/frontend.log`에 기록해 에러 모니터가 프론트 로그를 감시할 수 있도록 함.
  - PowerShell을 **전체 경로**(`%SystemRoot%\System32\WindowsPowerShell\v1.0\powershell.exe`)로 호출해, PATH 미설정 cmd 세션에서도 Frontend 패널이 정상 실행되도록 함.
- **`error_monitor.py`**: `main()` 진입 시 **`_ensure_log_directories()`**로 `backend/logs`, `frontend/logs` 선제 생성.
- **eco.bat [1]**: 첫 패널에서 `cmd /c` → **`cmd /k`** 로 변경해, 모니터 프로세스 종료 시에도 패널이 닫히지 않도록 함.

### 3-3. 트러블슈팅 문서
- **`docs/TROUBLESHOOTING.md`**: §9 추가 — 에러 모니터 미동작/프론트 에러 미감지 시 **가상환경 Python 경로**, **Frontend 로그 리다이렉션(Tee-Object)** 확인 가이드.
- **`docs/ERROR_MONITOR_DEBUG_PROMPT.md`**: 다른 LLM 에이전트에 넘길 수 있는 **에러 모니터 디버깅용 복사 프롬프트** 정리.

---

## 4. 변경·추가된 주요 파일 요약

| 구분 | 경로 | 내용 |
|------|------|------|
| 신규 | `backend/scripts/*.py` | 격리된 유틸리티 22개 (logger, 동기 Supabase 등) |
| 신규 | `supabase/migrations/20260220_enable_rls_all.sql` | RLS 활성화 마이그레이션 |
| 신규 | `docs/ERROR_MONITOR_DEBUG_PROMPT.md` | 에러 모니터 디버깅 프롬프트 |
| 신규 | `docs/SESSION_2026-02-20.md` | 본 세션 요약 |
| 수정 | `scripts/launch_wt_dev.ps1` | venv Python, Tee-Object, PowerShell 전체 경로 |
| 수정 | `error_monitor.py` | 로그 디렉터리 선제 생성 |
| 수정 | `frontend/src/hooks/useWebSocket.ts` | Stealth logging (스캐너 우회) |
| 수정 | `docs/TROUBLESHOOTING.md` | §9 에러 모니터 가이드 |
| 삭제 | `backend/*.py` (유틸 22개) | `backend/scripts/`로 이전됨 |

---

## 5. 검증 체크리스트

- [ ] **eco.bat → [1]** 실행 시 3분할 WT(Error Monitor / Backend / Frontend) 정상 기동
- [ ] Error Monitor 패널에 `[Backend] 감시`, `[Frontend] 감시` 출력 후 대기
- [ ] Frontend 패널에서 `powershell` 인식 오류 없이 `npm run tauri dev` 실행
- [ ] `frontend/logs/frontend.log` 생성·갱신 여부 확인
- [ ] `backend/.env`에 `ENABLE_DEV_ROUTES=true` 설정 후 백엔드 재시작, 더미 환자 추가(DEV) 동작 확인
- [ ] Environment Doctor / Security Audit 실행 시 **[SUCCESS]** 또는 **[OK]** 확인

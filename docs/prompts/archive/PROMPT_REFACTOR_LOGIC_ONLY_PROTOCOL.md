# [리팩토링 프롬프트] 논리적 결함만 제거하는 리팩토링 프로토콜

> 다른 LLM과 리팩토링 방향을 맞출 때 사용하는 **원칙 정의** 문서입니다. 본 문서 + `PROMPT_REFACTOR_AREAS_AND_CHECKLIST.md`를 함께 전달하세요.

---

## 1. 목표

**기존 코드의 구조·스타일·아키텍처는 유지한 채, 논리적 결함(race condition, 잘못된 가정, 응답 형식 오해 등)만 제거하는 리팩토링**을 진행한다.

- **하지 않는 것**: 대규모 구조 변경, 불필요한 추상화, 스타일 통일, 성능 최적화(논리 버그가 아닌 경우), 새 의존성 추가.
- **하는 것**: 버그를 유발하는 조건 분기·타이밍·데이터 가정의 수정, ref/가드의 올바른 배치, API 계약과 코드 사용처의 일치.

---

## 2. 프로젝트 제약 (필수 준수)

- **SSOT**: `docs/CRITICAL_LOGIC.md`에 정의된 도메인·기술 원칙을 위반하지 않는다.
- **레이어**: Backend는 Router → Service → Utils/Repo, Frontend는 훅에 비즈니스 로직·컴포넌트는 표시 위주.
- **동기화**: WebSocket은 트리거, 실제 데이터 갱신은 클라이언트 refetch. 훅에는 500ms 스로틀 등 중복 fetch 방지가 이미 적용된 패턴이 있으면 유지·보완만 한다.
- **인코딩·환경**: 배치 파일 수정 시 인코딩 변경 금지. `docs/CRITICAL_LOGIC.md` §2.6, §3 참고.

---

## 3. “논리적 결함만 제거” 판단 기준

다음에 해당하면 **논리적 결함 제거**로 간주하고 수정 대상으로 한다.

| 유형 | 설명 | 수정 방향 |
|------|------|-----------|
| **경쟁 상태** | 비동기 응답 도착 순서·여러 트리거(effect + onOpen 등)로 인해 올바른 응답이 가드에 걸려 버려지거나, 잘못된 데이터로 상태가 덮어씌워지는 경우 | 시퀀스 ID 할당 시점, 초기 로드 전용 플래그(ref), 트리거 조건 분리 등 **최소 변경**으로 한 경로만 승리하도록 보장 |
| **응답 형식 오해** | `api.get<T>()`가 body를 직접 반환하는데 `res.data`로 접근하거나, 그 반대인 경우 | 실제 반환 형태에 맞춰 접근 방식만 수정 (구조 리팩토링 금지) |
| **중복 요청 부작용** | API 레이어의 디덱/캐시가 두 번째 호출자에게 `{}` 등을 반환해, 첫 번째 호출의 응답이 나중에 도착했을 때 시퀀스 가드에 걸리는 경우 | 호출 순서·역할 분리(예: 초기 로드 시 한 쪽 트리거만 사용)로 동일 URL 동시 호출을 피함 |
| **초기값·초기 로드** | 마운트 직후 한 번만 확실히 실행되어야 하는 로직이 스로틀·가드·다른 트리거와 겹쳐 실행되지 않거나, 잘못된 데이터로만 실행되는 경우 | `force` 플래그, `initialLoadDoneRef` 등으로 “최초 1회” 경로를 명시적으로 보장 |

**해당하지 않는 것**: 네이밍 변경, 파일 분할, 훅 합치기/쪼개기, 새 라이브러리 도입, 포맷/스타일만의 변경.

---

## 4. 수정 시 원칙 (Surgical Changes)

- **변경 범위**: 결함을 제거하는 데 필요한 최소 라인만 수정. 인접 로직·주석·포맷은 건드리지 않는다.
- **스타일**: 해당 파일의 기존 스타일(따옴표, 줄 길이, 네이밍)을 유지한다.
- **고아 코드**: 이번 수정으로만 사용처가 사라진 변수·import만 제거한다. 기존부터 쓰이지 않던 코드는 임의로 삭제하지 않는다.
- **검증**: 수정 후 해당 플로우(초기 로드, 재연결, 사용자 액션 1회 등)가 한 번은 기대대로 동작하는지 설명 가능해야 한다.

---

## 5. 다른 LLM에게 요청할 때 붙여넣을 문장 (복사용)

```
이 프로젝트에서는 "논리적 결함만 제거하는 리팩토링"을 진행하려고 합니다.
- 원칙: docs/prompts/PROMPT_REFACTOR_LOGIC_ONLY_PROTOCOL.md
- 적용 대상·체크리스트: docs/prompts/PROMPT_REFACTOR_AREAS_AND_CHECKLIST.md
- 프로젝트 SSOT: docs/CRITICAL_LOGIC.md

위 문서들을 읽은 뒤, [여기에 구체적인 모듈/현상 적기]에 대해 동일한 원칙으로 논리적 결함만 짚어 수정안을 제안해 주세요. 구조 변경이나 대규모 리팩터는 하지 마세요.
```

---

위 프로토콜을 기준으로, 적용 대상과 체크리스트는 `PROMPT_REFACTOR_AREAS_AND_CHECKLIST.md`에서 확인하면 됩니다.

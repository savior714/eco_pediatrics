# Logic-Only Refactoring — 아키텍트 검토 및 검증 가이드

> 에이전트가 진단·수정을 수행한 뒤, **논리적 무결성**을 확인할 때 사용하는 가이드입니다.  
> 진단 보고서 선행 전략과 함께 사용하면 예기치 않은 사이드 이펙트를 차단할 수 있습니다.

---

## 1. 아키텍트 최종 검토 포인트

### 1.1 `requestRef` 패턴의 엄격함

- **원칙**: "가장 최신의 요청만이 상태를 변경할 권한을 갖는다."
- **검증**: 비동기 훅을 수정할 때 **Ref 증가 시점이 실제 fetch 직전**인지 반드시 확인.
  - 스로틀/조건 통과 **이후**, `api.get`/`fetch` 호출 **직전**에 `currentRequestId = ++requestRef.current`가 있어야 함.
  - 스로틀 체크 **이전**에 ID를 올리면, 나중에 들어온 요청이 ID를 점유해 정상 응답이 가드에 걸릴 수 있음.

### 1.2 잔상 현상(Ghosting) 방지 (PatientDetailModal 등)

- **문제**: 모달을 닫았다가 다른 환자를 열 때, 이전 환자 데이터가 잠깐 보이는 현상.
- **검증**:
  - 모달이 **닫힐 때**(`onClose`) 내부 로컬 상태·비동기 요청을 초기화하거나 무시하는 로직이 있는가?
  - **`patientId`(또는 admissionId)가 바뀔 때** `useEffect`가 이전 데이터를 즉시 null/초기값으로 밀어버리는가?
- 이 두 가지가 이번 리팩토링의 핵심 승부처가 됨.

### 1.3 페이지 진입점의 조율 (dashboard/page.tsx)

- **비유**: 여러 훅이 동시에 구동되는 '오케스트라'.
- **검증**:
  - **권한 가드**: `enabled: !!token`(또는 동등 조건)이 토큰을 쓰는 모든 훅에 전파되어, 토큰 없이 요청이 나가지 않는가?
  - **데이터 의존성**: 스테이션/입원 리스트가 로드되기 전에 바이탈 등 하위 데이터 조회를 시도해 404를 유발하지 않는가?
- 이 두 가지만 해결해도 불필요한 네트워크 로그와 에러 팝업을 상당 부분 줄일 수 있음.

---

## 2. 에이전트 결과물 검증 (Master Auditor 3필터)

다른 에이전트가 `DIAGNOSIS_*.md`를 생성하거나 수정 PR을 올렸을 때, 아래 **3가지 필터**로 최종 컨펌하세요.

| 필터 | 질문 | 통과 기준 |
|------|------|-----------|
| **Surgical Check** | 수정된 라인 수가 결함 해결에 필요한 **최소한**인가? | 불필요한 리팩터·추가 로직 없음. |
| **Logic Consistency** | 기존 `requestRef`, `initialLoadDoneRef`, 스로틀(500ms) 패턴과 **충돌**하지 않는가? | 새 로직이 기존 가드/플래그를 약화시키지 않음. |
| **Style Preservation** | 변수명 변경, 구조 분해 할당 추가, 포맷 통일 등 **불필요한 스타일/구조 변경**이 포함되지 않았는가? | 논리만 수정, 코드 스타일은 기존 유지. |

**3필터 모두 통과한 경우에만** 머지/적용을 권장합니다.

---

## 3. 활용 순서

1. **진단 요청**: `PROMPT_LOGIC_ONLY_REFACTOR_BATCH.md`의 해당 섹션을 에이전트에 전달하고, **진단 보고서를 먼저 작성**하게 함.
2. **보고서 검토**: 생성된 `DIAGNOSIS_<모듈>_LOGIC.md`를 본 가이드 §1·§2로 검토.
3. **수정 지시**: 검토 통과 시에만 "진단서의 N번 결함에 대해 수정안 적용해줘"라고 **최소 범위**로 지시.
4. **최종 검증**: 수정 diff에 대해 Master Auditor 3필터를 다시 한 번 적용.

---

## 4. 관련 문서

- **프로토콜**: `PROMPT_REFACTOR_LOGIC_ONLY_PROTOCOL.md`
- **대상·체크리스트**: `PROMPT_REFACTOR_AREAS_AND_CHECKLIST.md`
- **맞춤형 프롬프트 모음**: `PROMPT_LOGIC_ONLY_REFACTOR_BATCH.md`
- **SSOT**: `docs/CRITICAL_LOGIC.md`
